<!-- Template for slidoc--->
  <style>
    body { line-height: 1.35;
           max-width: 960px;
           %(body_style)s }
    body .slidoc-toc-container { line-height: 1.6; }
    pre { padding: 0px 2em;}
    .slidoc-notes { padding: 0px 1em; font-size: 90%%; }
    .slidoc-notes p {margin: 0.3em 0;}
    .slidoc-clickable { padding: 0.3em 0 0 0; color: blue; text-decoration: underline; }
    .slidoc-clickable-sym { padding: 0.3em 0 0 0; color: blue; }
    .slidoc-clickable.slidoc-toc-entry { padding: 0.3em 0 0 1em; }

    a.slidoc-clickable-sym { text-decoration: none; }

    body.slidoc-slide-view { font-size: 150%%; }

    body.slidoc-slide-view .slidoc-noslide
          { display: none; }
    body:not(.slidoc-slide-view) .slidoc-slideonly
          { display: none; }

    .slidoc-slide-nav { z-index: 1000; position: fixed; right: 15px; bottom: 10px; }
    .slidoc-slide-view-button { z-index: 1000; position: fixed; right: 15px; bottom: 10px; }
  </style>

 %(math_js)s

  <script>
     var Slidoc = {};
     Slidoc.questions_answered = {};
     Slidoc.questions_count = 0;
     Slidoc.questions_correct = 0;

     Slidoc.chainQuery = '';
     Slidoc.showAll = false;
     Slidoc.slideView = 0;
     Slidoc.curChapterId = '';

     document.onkeydown = function(evt) {
        if (!Slidoc.slideView)
          return;
        switch (evt.keyCode) {
            case 27:  // Escape
                slidocSlideViewEnd();
                break;
            case 35:  // End
                slidocSlideViewGo(false,slidocGetVisibleSlides().length);
                break;
            case 36:  // Home
                slidocSlideViewGo(false,1);
                break;
            case 37:  // Left arrow
                slidocSlideViewGo(false);
                break;
            case 38: // Up arrow
                break;
            case 39: // Right arrow
                slidocSlideViewGo(true);
                break;
            case 40: // Down arrow
                break;
        }
     };

     function slidocGetBaseURL() {
     return (location.pathname.slice(-1)=='/') ? location.pathname : location.pathname.split('/').slice(0,-1).join('/');
     }

     function slidocGetParameter(name, number, queryStr) {
        // Set number to true, if expecting an integer value. Returns null if valid parameter is not present.
        // If queryStr is specified, it is used instead of location.search
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(queryStr || window.location.search);
        if (!match)
           return null;
        var value = decodeURIComponent(match[1].replace(/\+/g, ' '));
        if (number) {
            try { value = parseInt(value); } catch(err) { value = null };
        }
        return value;
     }

     function slidocHide(elem, className) {
        if (elem.text.charAt(0) == 'H') {
           elem.text = elem.text.replace('Hide', 'Show');
           if (className) slidocClassDisplay(className, 'none');
        } else {
           elem.text = elem.text.replace('Show', 'Hide');
           if (className) slidocClassDisplay(className, 'block');
        }
        return false;
     }

     function slidocAllDisplay(elem) {
        // Display all "chapters"
        slidocHide(elem);
        Slidoc.showAll = !Slidoc.showAll;
        var elements = document.getElementsByClassName('slidoc-container');
        for (var i = 0; i < elements.length; ++i) {
           elements[i].style.display= Slidoc.showAll ? null : 'none';
        }
        if (Slidoc.showAll) Slidoc.curChapterId = '';
        if (!Slidoc.showAll) slidocGo('#slidoc00');
        return false;
     }

     function slidocClassDisplay(className, displayValue) {
        // Set display value (string) for all elements with class
        // If !displayValue, toggle it
        var elements = document.getElementsByClassName(className);
        for (var i = 0; i < elements.length; ++i) {
          if (displayValue)
             elements[i].style.display = displayValue;
          else
             elements[i].style.display = (elements[i].style.display=='block') ? 'none' : 'block'
        }
        return false;
     }

     function slidocIdDisplay(idValue, displayValue) {
        // Set display value (string) for element with it
        // If !displayValue, toggle it
         var element = document.getElementById(idValue);
         if (displayValue)
           element.style.display = displayValue;
         else
           element.style.display = (element.style.display=='block') ? 'none' : 'block';
        return false;
     }

     function slidocToggleInlineId(idValue) {
        var element = document.getElementById(idValue);
        element.style.display = (element.style.display=='inline') ? 'none' : 'inline';
        return false;
     }

     function slidocToggleInline(elem) {
        var elements = elem.children;
        for (var i = 0; i < elements.length; ++i) {
           elements[i].style.display = (elements[i].style.display=='inline') ? 'none' : 'inline';
        }
        return false;
     }

     function slidocChoiceClick(elem, slide_id, question_number, choice_val) {
        console.log("slidocChoiceClick:", slide_id, question_number, choice_val);
        if (question_number in Slidoc.questions_answered)
           return;
        Slidoc.questions_answered[question_number] = choice_val;

        elem.style['text-decoration'] = 'line-through';
        var choices = document.getElementsByClassName(slide_id+"-choice");
        for (var i = 0; i < choices.length; ++i) {
           choices[i].removeAttribute("onclick");
           choices[i].classList.remove("slidoc-clickable");
        }
        var notes_id = slide_id+"-notes";
        slidocIdDisplay(notes_id);
        var notes_elem = document.getElementById(notes_id);
        if (notes_elem) notes_elem.style.display = 'inline';
        var concept_elem = document.getElementById(slide_id+"-concepts");
        var concept_list = concept_elem ? concept_elem.textContent.split('; ') : ';';
        var ans_elem = document.getElementById(slide_id+"-answer");
        if (ans_elem) ans_elem.style.display = 'inline';
        var corr_elem = document.getElementById(slide_id+"-correct");
        if (corr_elem) {
           var corr_answer = corr_elem.textContent;
           console.log('slidocChoiceClick:corr', corr_answer, concept_list);
           if (corr_answer) {
               Slidoc.questions_count += 1;
               var corr_choice = document.getElementById(slide_id+"-choice-"+corr_answer);
               if (corr_choice) {
                corr_choice.style['text-decoration'] = '';
                corr_choice.style['font-weight'] = 'bold';
              }
              var resp_elem = document.getElementById(slide_id+"-resp");
              if (resp_elem && choice_val) {
                 if (choice_val == corr_answer)  {
                    Slidoc.questions_correct += 1;
                    resp_elem.innerHTML = " &#x2714;&nbsp; ("+Slidoc.questions_correct+"/"+Slidoc.questions_count+")";
                 } else {
                    resp_elem.innerHTML = " &#x2718;&nbsp; ("+Slidoc.questions_correct+"/"+Slidoc.questions_count+")";
                 }
               }
            }
        }
        return false;
     }

     function slidocAnswerClick(elem, slide_id, question_number, choice_type) {
        console.log("slidocAnswerClick:", slide_id, choice_type);
        slidocToggleInline(elem);
        if (choice_type) {
           var notes_id = slide_id+"-notes";
           var notes_link = document.getElementById(notes_id);
           if (notes_link) {
               // Display any notes associated with this question
               notes_link.style.display = "inline";
               slidocIdDisplay(notes_id);
           }
        }
        return false;
     }

     function slidocGetVisibleSlides() {
        var slideClass = 'slidoc-slide';
        if (Slidoc.curChapterId) {
           var curChap = document.getElementById(Slidoc.curChapterId);
           if (curChap.classList.contains('slidoc-noslide'))
             return null;
           slideClass = Slidoc.curChapterId+'-slide';
        }
        return document.getElementsByClassName(slideClass);
     }


     function slidocSlideViewStart() {
        if (Slidoc.slideView) 
           return false;
        var slides = slidocGetVisibleSlides();
        if (!slides)
           return false;
        Slidoc.slideView = 1;
        for (var i=0; i<slides.length; ++i) {
            var topOffset = slides[i].getBoundingClientRect().top;
            if (topOffset >= 0 && topOffset < window.innerHeight) {
               Slidoc.slideView = i+1;
               break;
            }
        }
        slidocClassDisplay('slidoc-notes', 'none');
        document.body.classList.add('slidoc-slide-view');

        slidocSlideViewGo(false, Slidoc.slideView);
        return false;
     }

     function slidocSlideViewEnd() {
        document.body.classList.remove('slidoc-slide-view');
        slidocClassDisplay('slidoc-slide', 'block');
        slidocClassDisplay('slidoc-notes', 'block');
        var slides = slidocGetVisibleSlides();
        if (slides && Slidoc.slideView > 0 && Slidoc.slideView <= slides.length) {
          location.href = '#'+slides[Slidoc.slideView-1].id;
        }
        Slidoc.slideView = 0;
        return false;
     }

     function slidocSlideViewGo(forward, slide_num) {
        console.log('slidocSlideViewGo:', forward, slide_num);
        if (!Slidoc.slideView)
           return false;
        if (!slide_num) slide_num = forward ? Slidoc.slideView+1 : Slidoc.slideView-1;
        var slides = slidocGetVisibleSlides();
        if (!slides || slide_num < 1 || slide_num > slides.length)
           return false;

        var prev_elem = document.getElementById('slidoc-slide-nav-prev');
        var next_elem = document.getElementById('slidoc-slide-nav-next');
        prev_elem.style.visibility = (slide_num == 1) ? 'hidden' : 'visible';
        next_elem.style.visibility = (slide_num == slides.length) ? 'hidden' : 'visible';

        slidocClassDisplay('slidoc-slide', 'none');
        slides[slide_num-1].style.display = 'block';
        Slidoc.slideView = slide_num;
        location.href = '#'+slides[Slidoc.slideView-1].id;
        return false;
     }

     function slidocGo(slideHash, chained) {
        // Scroll to slide with slideHash, hiding current chapter and opening new one
        // If chained, hide previos link and set up new link
        console.log("slidocGo:", slideHash, chained);
        var slideId = slideHash.substr(1);
        var element = document.getElementById(slideId);
        console.log('slidocGo2: ', slideId, chained, element);
        if (element) {
           if (chained) {
               // Hide current chain link
               var tagid = location.hash.substr(1);
               var ichain_elem = document.getElementById(tagid+"-ichain");
               if (ichain_elem)
                   ichain_elem.style.display = 'none';
            } else {
               // End chain
               Slidoc.chainQuery = '';
            }

            var match = RegExp('slidoc(\\d+)(-.*)?$').exec(slideId);
            if (match && !Slidoc.showAll) {
              // Hide all and expose next slide
              var chapnum = parseInt(match[1]);
              Slidoc.curChapterId = 'slidoc'+match[1];
              var chapters = document.getElementsByClassName('slidoc-container');
              for (var i = 0; i < chapters.length; ++i) {
                 chapters[i].style.display = (i == chapnum) ? 'block' : 'none';
              }
            } else {
              Slidoc.curChapterId = '';
            }
            location.hash = slideHash;

            if (chained && Slidoc.chainQuery)  // Set up new chain link
               slidocChainUpdate(Slidoc.chainQuery);

            element.scrollIntoView(true); // Redundant?
        }
        return false;
     }

     function slidocChainLink(newindex, queryStr, urlPath) {
        // Returns next/prev chain URL: /(prefix)(newtag0).html?index=1&taglist=...#newtag1
        // tag = fsuffix#id
        // If not urlPath, return the new query string+hash (without the path)
        console.log("slidocChainLink:", newindex, queryStr, urlPath);
        var tagindex = slidocGetParameter('tagindex', true, queryStr);
        var taglist = (slidocGetParameter('taglist', false, queryStr) || '').split(";");
        var curcomps = taglist[tagindex-1].split("#");
        var newcomps = taglist[newindex-1].split("#");
        var newQuery = queryStr.replace('index='+tagindex, 'index='+newindex);
        if (!urlPath) {
            return newQuery + '#' + newcomps[1];
        }
        var suffix = ".html";
        var prefix = urlPath.substr(0, urlPath.length-(curcomps[0]+suffix).length);
        return prefix + newcomps[0] + suffix + newQuery + '#' + newcomps[1];
     }

     function slidocChainURL(newindex) {
        // Return URL to load next link in concept chain
        console.log("slidocChainURL:", newindex);
        return slidocChainLink(newindex, location.search, location.pathname);
     }

     function slidocChainNav(newindex) {
        // Navigate to next link in concept chain
        console.log("slidocChainNav:", newindex);
        if (!Slidoc.chainQuery)
           return;
        var comps = slidocChainLink(newindex, Slidoc.chainQuery).split('#');
        Slidoc.chainQuery = comps[0];
        slidocGo('#'+comps[1], true);
     console.log("slidocChainNav2:", location.hash);
        return false;
     }

     function slidocChainStart(queryStr, slideHash) {
        // Go to first link in concept chain
        console.log("slidocChainStart:", slideHash, queryStr);
        Slidoc.chainQuery = queryStr;
        slidocGo(slideHash, true);
        return false;
     }

     function slidocReady(event) {
        console.log("slidocReady:");
        slidocChainUpdate(location.search);
        var toc_elem = document.getElementById("slidoc00");
        if (toc_elem) slidocGo(location.hash || "#slidoc00");
     }

     function slidocChainUpdate(queryStr) {
         queryStr = queryStr || location.search;
         var tagid = location.hash.substr(1);
         console.log("slidocChainUpdate:", queryStr, tagid);

         var ichain_elem = document.getElementById(tagid+"-ichain");
         if (!ichain_elem)
            return;

         var tagindex = slidocGetParameter('tagindex', true, queryStr);
         console.log("slidocChainUpdate2:", tagindex);
         if (!tagindex)
           return;
         var tagconcept = slidocGetParameter('tagconcept', false, queryStr) || '';
         var tagconceptref = slidocGetParameter('tagconceptref', false, queryStr) || '';
         var taglist = (slidocGetParameter('taglist', false, queryStr) || '').split(";");

         if (tagindex) {
             ichain_elem.style.display = 'block';
             var concept_elem = document.getElementById(tagid+"-ichain-concept");
             concept_elem.text = tagconcept;
             if (Slidoc.chainQuery) {
                 concept_elem.onclick = function() {slidocGo(tagconceptref);}
             } else {
                 concept_elem.href = slidocGetBaseURL()+'/'+tagconceptref;
             }
             var prev_elem = document.getElementById(tagid+"-ichain-prev");
             if (tagindex > 1) {
                if (Slidoc.chainQuery) {
                    prev_elem.onclick = function() {slidocChainNav(tagindex-1);}
                    prev_elem.classList.add("slidoc-clickable-sym");
                } else {
                  prev_elem.href = slidocChainURL(tagindex-1);
                }
             } else {
                delete prev_elem.href;
                delete prev_elem.onclick;
                prev_elem.classList.remove("slidoc-clickable-sym");
             }
             var next_elem = document.getElementById(tagid+"-ichain-next");
             if (tagindex < taglist.length) {
                if (Slidoc.chainQuery) {
                    next_elem.onclick = function() {slidocChainNav(tagindex+1);}
                    next_elem.classList.add("slidoc-clickable-sym");
                } else {
                   next_elem.href = slidocChainURL(tagindex+1);
                }
             } else {
                delete next_elem.href;
                delete next_elem.onclick;
                next_elem.classList.remove("slidoc-clickable-sym");
             }
         }
     console.log("slidocChainUpdate:4", location.hash);
     }

     document.onreadystatechange = function(event) {
         console.log('onreadystatechange:', document.readyState);
         if (document.readyState != "interactive")
           return;
         try {
            slidocReady();
         } catch(err) {console.log("slidocReady: ERROR", err);}
     }

  </script>

